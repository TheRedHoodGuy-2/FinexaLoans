<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinexaLoans - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="./scripting.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              card: "hsl(var(--card))",
              border: "hsl(var(--border))",
              secondary: "hsl(var(--secondary))",
              muted: "hsl(var(--muted))",
              "muted-foreground": "hsl(var(--muted-foreground))",
              destructive: "hsl(var(--destructive))",
              success: "hsl(var(--success))",
              warning: "hsl(var(--warning))",
              primary: "hsl(var(--primary))",
              "primary-foreground": "hsl(var(--primary-foreground))",
              "warning-foreground": "hsl(var(--warning-foreground))",
              // ADDED INFO COLOR FOR PENDING/IN-PROGRESS (Blueish)
              info: "hsl(210 90% 50%)",
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
            animation: {
              "fade-in": "fade-in 0.4s ease-out forwards",
            },
            keyframes: {
              "fade-in": {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      /* BASE LAYER from stylesheet */
      :root {
        --background: 0 0% 0%;
        --foreground: 0 0% 100%;
        --card: 0 0% 4%;
        --card-foreground: 0 0% 100%;
        --primary: 0 0% 100%;
        --primary-foreground: 0 0% 0%;
        --secondary: 0 0% 10%;
        --secondary-foreground: 0 0% 100%;
        --muted: 0 0% 15%;
        --muted-foreground: 0 0% 65%;
        --destructive: 0 62% 50%;
        --success: 142 76% 45%;
        --warning: 45 93% 55%;
        --warning-foreground: 0 0% 0%; /* Black text on yellow */
        --border: 0 0% 15%;
        --input: 0 0% 15%;
        --radius: 0.75rem;
      }

      /* FONT from stylesheet */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      /* UTILITIES from stylesheet (applied via custom classes in HTML) */
      .glass-hover {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 300ms;
        background-color: hsl(var(--card) / 0.7);
        border-color: hsl(var(--border) / 1);
      }

      /* MODERN TOAST STYLES */
      .toast-pill {
        background: hsl(var(--card));
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        color: hsl(var(--foreground));
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      }
      .icon-border {
        border-radius: 9999px; /* rounded-full */
        padding: 2px;
        border: 1px solid currentColor;
      }

      .loan-card-clickable {
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-background text-foreground min-h-screen">
    <!-- Frontend Section -->
    <div
      id="toast-container"
      class="fixed top-4 right-4 z-[100] space-y-2"
    ></div>

    <div id="root"></div>

    <div id="modals-container">
      <div
        id="new-loan-modal"
        class="fixed inset-0 z-50 items-center justify-center p-4 hidden"
      >
        <div
          class="absolute inset-0 bg-background/80 backdrop-blur-sm"
          onclick="window.FinexaModal.closeNewLoanModal()"
        ></div>
        <div
          class="relative w-full max-w-md rounded-2xl border border-border/30 bg-card p-6 animate-fade-in"
        >
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Apply for a Loan</h2>
            <button
              onclick="window.FinexaModal.closeNewLoanModal()"
              class="p-2 rounded-lg hover:bg-secondary transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewbox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-x h-5 w-5"
              >
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>

          <form id="new-loan-form" class="space-y-5">
            <div class="space-y-2">
              <label>Loan Type</label>
              <select
                id="loan-type"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              >
                <option value="">Select loan type</option>
                <option value="Personal">Personal</option>
                <option value="Business">Business</option>
                <option value="Mortgage">Mortgage</option>
                <option value="Auto">Auto</option>
                <option value="Education">Education</option>
              </select>
              <p
                id="error-loanType"
                class="text-sm text-destructive hidden"
              ></p>
            </div>

            <div class="space-y-2">
              <label for="amount">Amount (₦)</label>
              <input
                id="amount"
                type="number"
                placeholder="500000"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              />
              <p id="error-amount" class="text-sm text-destructive hidden"></p>
            </div>

            <div class="space-y-2">
              <label for="duration">Duration (Months)</label>
              <input
                id="duration"
                type="number"
                placeholder="12"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              />
              <p
                id="error-durationMonths"
                class="text-sm text-destructive hidden"
              ></p>
            </div>

            <div class="space-y-2">
              <label for="collateral">Collateral (Optional)</label>
              <input
                id="collateral"
                placeholder="e.g., Vehicle Title, Property Deed"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              />
            </div>

            <button
              type="submit"
              id="new-loan-submit"
              class="w-full h-12 bg-primary text-primary-foreground hover:bg-primary/90 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
            >
              Submit Application
            </button>
          </form>
        </div>
      </div>

      <div
        id="payment-modal"
        class="fixed inset-0 z-50 items-center justify-center p-4 hidden"
      >
        <div
          class="absolute inset-0 bg-background/80 backdrop-blur-sm"
          onclick="window.FinexaModal.closePaymentModal()"
        ></div>
        <div
          class="relative w-full max-w-md rounded-2xl border border-border/30 bg-card p-6 animate-fade-in"
        >
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Make a Payment</h2>
            <button
              onclick="window.FinexaModal.closePaymentModal()"
              class="p-2 rounded-lg hover:bg-secondary transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewbox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-x h-5 w-5"
              >
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>

          <div id="no-loans-message" class="text-center py-8 hidden">
            <p class="text-muted-foreground">No active loans to pay</p>
          </div>

          <form id="payment-form" class="space-y-5 hidden">
            <div class="space-y-2">
              <label>Select Loan</label>
              <select
                id="payment-loan-select"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              >
                <option value="">Choose a loan</option>
              </select>
            </div>

            <div
              id="loan-details"
              class="p-4 rounded-xl bg-secondary/50 border border-border/30 hidden"
            >
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-muted-foreground"
                  >Outstanding Balance</span
                >
                <span id="loan-balance" class="font-semibold"></span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-muted-foreground">Interest Rate</span>
                <span id="loan-interest" class="font-medium"></span>
              </div>
            </div>

            <div class="space-y-2">
              <label for="payment-amount">Payment Amount (₦)</label>
              <input
                id="payment-amount"
                type="number"
                placeholder="Enter amount"
                class="flex w-full rounded-md border px-3 py-2 text-base h-12 bg-secondary/70 border-border focus:outline-none focus:ring-2 focus:ring-offset-2"
              />
              <p id="error-payment" class="text-sm text-destructive hidden"></p>
            </div>

            <button
              type="submit"
              id="pay-loan-submit"
              class="w-full h-12 bg-primary text-primary-foreground hover:bg-primary/90 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
            >
              Confirm Payment
            </button>
          </form>
        </div>
      </div>

      <div
        id="loan-details-modal"
        class="fixed inset-0 z-50 items-center justify-center p-4 hidden"
      >
        <div
          class="absolute inset-0 bg-background/80 backdrop-blur-sm"
          onclick="window.FinexaModal.closeLoanDetailsModal()"
        ></div>
        <div
          class="relative w-full max-w-md rounded-2xl border border-border/30 bg-card p-6 animate-fade-in"
        >
          <div class="flex items-center justify-between mb-6">
            <h2 id="modal-loan-type" class="text-xl font-semibold">
              Loan Details
            </h2>
            <button
              onclick="window.FinexaModal.closeLoanDetailsModal()"
              class="p-2 rounded-lg hover:bg-secondary transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewbox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-x h-5 w-5"
              >
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>

          <div id="modal-content" class="space-y-4">
            <div
              class="p-4 rounded-xl bg-secondary/50 border border-border/30"
              id="modal-status-card"
            >
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-muted-foreground"
                  >Current Status</span
                >
                <span
                  id="modal-status"
                  class="font-semibold px-3 py-1 rounded-full text-xs"
                ></span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-muted-foreground"
                  >Outstanding Balance</span
                >
                <span id="modal-amount" class="font-bold text-lg"></span>
              </div>
            </div>

            <div class="space-y-2" id="payment-summary-section">
              <div
                class="text-sm space-y-2 border border-secondary p-3 rounded-lg"
              >
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground"
                    >Original Loan Amount:</span
                  >
                  <span
                    id="modal-original-amount"
                    class="font-medium text-foreground"
                  ></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Total Paid to Date:</span>
                  <span
                    id="modal-total-paid"
                    class="font-medium text-success"
                  ></span>
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <h4 class="font-semibold text-muted-foreground">
                Key Information
              </h4>
              <div
                class="text-sm space-y-2 border border-secondary p-3 rounded-lg"
              >
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Rate:</span>
                  <span id="modal-rate"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Duration:</span>
                  <span id="modal-duration"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Collateral:</span>
                  <span id="modal-collateral"></span>
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <h4 class="font-semibold text-muted-foreground">
                Payment History
              </h4>
              <div
                class="space-y-1 text-sm border border-secondary p-3 rounded-lg max-h-40 overflow-y-auto"
                id="modal-payment-history"
              >
                <div class="text-muted-foreground text-center py-2">
                  No payments recorded.
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <h4 class="font-semibold text-muted-foreground">Dates</h4>
              <div
                class="text-sm space-y-2 border border-secondary p-3 rounded-lg"
              >
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Application Date:</span>
                  <span id="modal-created-at"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Approval Date:</span>
                  <span id="modal-approved-at"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted-foreground">Due Date:</span>
                  <span id="modal-due-date" class="font-semibold"></span>
                </div>
              </div>
            </div>

            <button
              id="modal-pay-button"
              class="w-full h-12 bg-primary text-primary-foreground hover:bg-primary/90 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
            >
              Make Payment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- CGI Section for Dashboard Logic -->
    <script type="module">
      import {
        fetchLoans,
        insertNewLoan,
        getCurrentUser,
        signOut,
        DashboardConstants,
        makePayment,
        supabaseClient,
      } from "./scripting.js";

      // --- DATA & UTILITIES (Kept locally for dashboard processing) ---

      const INTEREST_RATES = DashboardConstants.INTEREST_RATES;
      let loans = []; // Now initialized empty, filled by fetch
      let selectedLoanForPayment = null;
      let currentUserId = null;

      // Helper to calculate due date
      function calculateDueDate(approvedAt, durationMonths) {
        if (!approvedAt) return "N/A";
        const date = new Date(approvedAt);
        date.setMonth(date.getMonth() + durationMonths);
        return date.toISOString().split("T")[0];
      }

      // Helper to check if a loan is past due (SIMULATED)
      function checkPastDue(loan) {
        // We use loan.start_date from the DB as the approval date
        if (loan.status !== "Active" || !loan.start_date) return false;

        // Use current date for simulation (in a real app, this would be Date.now())
        const simulatedToday = new Date("2025-12-06");

        const approvedDate = new Date(loan.start_date);
        const dueDate = new Date(approvedDate);
        dueDate.setMonth(dueDate.getMonth() + loan.duration_months);

        return dueDate < simulatedToday;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-NG", {
          style: "currency",
          currency: "NGN",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // REDESIGNED TOAST FUNCTION (Copied from scripting.js logic structure)
      function showToast(message, type = "success", title = "Status") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");

        let textClass = "text-success";
        let iconHtml =
          '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>';
        let iconBorderClass = "border-success";

        if (type === "error") {
          textClass = "text-destructive";
          iconBorderClass = "border-destructive";
          iconHtml =
            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
          title = "Error!";
        } else if (type === "warning") {
          textClass = "text-warning";
          iconBorderClass = "border-warning";
          iconHtml =
            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hourglass"><path d="M5 18v-3.5a1.5 1.5 0 0 1 3 0V18"/><path d="M5 6v3.5a1.5 1.5 0 0 0 3 0V6"/><line x1="8" x2="16" y1="18" y2="18"/><line x1="8" x2="16" y1="6" y2="6"/><path d="M16 18v-3.5a1.5 1.5 0 0 0-3 0V18"/><path d="M16 6v3.5a1.5 1.5 0 0 1-3 0V6"/><path d="M22 22 16 18 13.5 15.5 13.5 8.5 16 6 22 2M2 2l6 4 2.5 2.5 0 7 2.5 2.5 6 4"/></svg>';
          title = "Pending...";
        } else if (type === "info") {
          textClass = "text-info";
          iconBorderClass = "border-info";
          iconHtml =
            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>';
          title = "Info";
        }

        toast.className = "p-3 w-80 toast-pill animate-fade-in";

        toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="icon-border ${iconBorderClass} ${textClass}">
                        ${iconHtml}
                    </div>
                    <div class="flex-1 space-y-0.5">
                        <p class="font-semibold text-sm">${title}</p>
                        <p class="text-muted-foreground text-sm">${message}</p>
                    </div>
                    <button onclick="this.closest('.toast-pill').remove()" class="text-muted-foreground hover:text-foreground">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
            `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.remove("animate-fade-in");
          toast.classList.add("opacity-0", "translate-y-2");
          toast.addEventListener("transitionend", () => toast.remove());
        }, 4000);
      }

      // FIX 1B: Function to update DB status after delay
      async function updateLoanStatusInDB(loanId, newStatus) {
        // Find the specific loan in the local array to ensure we have the full details
        const loanToUpdate = loans.find((l) => l.loan_id === loanId);
        if (!loanToUpdate) return;

        // Use the original amount as the initial amount for an 'Active' loan
        const amountToSet = loanToUpdate.amount;

        const { data, error } = await supabaseClient
          .from("loans")
          .update({
            status: newStatus,
            start_date: new Date().toISOString().split("T")[0],
            // Ensure the amount is reset/set correctly upon activation
            // NOTE: In a real system, you'd calculate the final loan amount including fees here.
            // For this demo, we use the requested amount as the starting balance.
            amount: amountToSet,
          })
          .eq("loan_id", loanId)
          .select();

        if (error) {
          showToast(
            `Failed to auto-approve loan ${loanId}. ${error.message}`,
            "error",
            "Approval Error"
          );
        } else {
          showToast(
            `Loan ${loanId} approved successfully!`,
            "success",
            "Approval Complete"
          );
          await renderDashboard(); // Re-render to show updated status
        }
      }

      // FIX 1A: Simulation logic re-implemented
      function scheduleLoanApproval(loanId) {
        const FIVE_SECONDS = 5000; // Reduced for testing/demo

        // Check if a timer is already running for this loan to prevent duplicates
        if (sessionStorage.getItem(`approval-timer-${loanId}`)) {
          return;
        }

        showToast(
          "Scheduling loan for approval check...",
          "info",
          "Processing"
        );

        const timer = setTimeout(async () => {
          await updateLoanStatusInDB(loanId, "Active");
          sessionStorage.removeItem(`approval-timer-${loanId}`);
        }, FIVE_SECONDS);

        // Store the timer ID to prevent immediate re-scheduling on reload
        sessionStorage.setItem(`approval-timer-${loanId}`, timer);
      }

      // --- DASHBOARD STATE & RENDER ---

      function getStatusStyles(status) {
        switch (status) {
          case "Active":
            return "bg-warning/10 text-warning";
          case "Pending":
            return "bg-info/10 text-info";
          case "Paid":
            return "bg-success/10 text-success";
          case "Defaulted":
            return "bg-destructive/10 text-destructive";
          default:
            return "bg-muted text-muted-foreground";
        }
      }

      function getLoanDisplayStatus(loan) {
        if (loan.status === "Active" && checkPastDue(loan)) {
          return {
            status: "Past Due",
            style: "bg-destructive/20 text-destructive font-bold",
          };
        }
        return { status: loan.status, style: getStatusStyles(loan.status) };
      }

      async function renderDashboard() {
        const root = document.getElementById("root");

        // 1. Fetch data from Supabase
        const fetchedLoans = await fetchLoans();
        loans = fetchedLoans;

        // 1B. Check for stuck pending loans and schedule approval for them
        loans
          .filter((l) => l.status === "Pending")
          .forEach((loan) => {
            scheduleLoanApproval(loan.loan_id);
          });

        const activeLoans = loans.filter((l) => l.status === "Active");
        // NOTE: totalActive uses the remaining 'amount' field.
        const totalActive = activeLoans.reduce(
          (sum, l) => sum + parseFloat(l.amount || 0),
          0
        );
        const pendingCount = loans.filter((l) => l.status === "Pending").length;
        const paidCount = loans.filter((l) => l.status === "Paid").length;
        const totalLoans = loans.length;

        root.innerHTML = `
                <div class="min-h-screen bg-background">
                    <header class="border-b border-border/30">
                        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                            <a href="index.html" class="text-xl font-semibold">FinexaLoans</a>
                            <div class="flex items-center gap-3">
                                <button id="make-payment-btn" class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium rounded-md border bg-card hover:bg-secondary h-9 px-3 border-border">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card h-4 w-4 mr-2"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                                    Make Payment
                                </button>
                                <button id="logout-btn" class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium hover:bg-secondary h-9 rounded-md px-3 text-muted-foreground hover:text-foreground">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out h-4 w-4"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-6xl mx-auto px-6 py-10">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
                            
                            <div class="p-6 rounded-2xl border border-warning/30 bg-warning/5">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-xl bg-warning/10 flex items-center justify-center">
                                        <span class="text-warning font-semibold text-lg">${
                                          activeLoans.length
                                        }</span>
                                    </div>
                                    <span class="text-sm text-muted-foreground">Active Loans</span>
                                </div>
                                <div class="text-2xl font-bold text-warning">${formatCurrency(
                                  totalActive
                                )}</div>
                                <div class="text-xs text-muted-foreground mt-1">Outstanding Balance</div>
                            </div>
                            
                            <div class="p-6 rounded-2xl border border-info/30 bg-info/5">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-xl bg-info/10 flex items-center justify-center">
                                        <span class="text-info font-semibold text-lg">${pendingCount}</span>
                                    </div>
                                    <span class="text-sm text-muted-foreground">Pending Applications</span>
                                </div>
                                <div class="text-2xl font-bold text-info">${
                                  pendingCount === 0
                                    ? "All Clear"
                                    : pendingCount + " waiting"
                                }</div>
                                <div class="text-xs text-muted-foreground mt-1">Awaiting approval</div>
                            </div>
                            
                            <div class="p-6 rounded-2xl border border-success/30 bg-success/5">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-xl bg-success/10 flex items-center justify-center">
                                        <span class="text-success font-semibold text-lg">${paidCount}</span>
                                    </div>
                                    <span class="text-sm text-muted-foreground">Completed Loans</span>
                                </div>
                                <div class="text-2xl font-bold text-success">${paidCount} paid off</div>
                                <div class="text-xs text-muted-foreground mt-1">Great job!</div>
                            </div>
                            
                            <div class="p-6 rounded-2xl border border-border bg-card">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-xl bg-secondary flex items-center justify-center">
                                        <span class="text-muted-foreground font-semibold text-lg">${totalLoans}</span>
                                    </div>
                                    <span class="text-sm text-muted-foreground">Total Loans</span>
                                </div>
                                <div class="text-2xl font-bold">${totalLoans} applications</div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Your Loans</h2>
                            <button id="new-loan-btn" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus h-4 w-4 mr-2"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                                New Loan
                            </button>
                        </div>

                        <div class="loans-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${loans
                              .map((loan) => {
                                const display = getLoanDisplayStatus(loan);
                                const isPayable =
                                  loan.status === "Active" ||
                                  display.status === "Past Due";

                                // Calculate Original Amount for Card Display (if needed)
                                const totalPaid = loan.payments
                                  ? loan.payments.reduce(
                                      (sum, p) =>
                                        sum + parseFloat(p.amount_paid),
                                      0
                                    )
                                  : 0;
                                const originalAmount =
                                  parseFloat(loan.amount) + totalPaid;

                                return `
                                <div 
                                    class="p-6 rounded-2xl border border-border bg-card glass-hover loan-card-clickable"
                                    data-loan-id="${loan.loan_id}"
                                    onclick="window.FinexaModal.showLoanDetails('${
                                      loan.loan_id
                                    }')"
                                >
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-lg font-semibold">${
                                          loan.loan_type
                                        } Loan</h3>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                          display.style
                                        }">
                                            ${display.status}
                                        </span>
                                    </div>
                                    
                                    <div class="text-3xl font-bold my-3 ${
                                      display.status === "Past Due"
                                        ? "text-destructive"
                                        : "text-foreground"
                                    }">
                                        ${formatCurrency(loan.amount)}
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-sm text-muted-foreground">
                                        <span>Original: ${formatCurrency(
                                          originalAmount
                                        )}</span>
                                        ${
                                          isPayable
                                            ? `
                                            <button 
                                                class="pay-loan-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-xs font-medium rounded-md border bg-card hover:bg-secondary h-7 px-3 border-border shrink-0 z-10"
                                                data-loan-id="${loan.loan_id}"
                                                onclick="event.stopPropagation(); window.FinexaModal.showPaymentModal('${loan.loan_id}')"
                                            >
                                                Pay Now
                                            </button>
                                        `
                                            : ""
                                        }
                                    </div>
                                </div>
                                `;
                              })
                              .join("")}

                            ${
                              loans.length === 0
                                ? `
                                <div class="text-center py-16 col-span-full">
                                    <p class="text-muted-foreground mb-4">No loans yet</p>
                                    <button id="no-loans-apply-btn" class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium h-10 px-4 py-2">
                                        Apply for a Loan
                                    </button>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </main>
                </div>
            `;

        // Attach event handlers after rendering
        document
          .getElementById("new-loan-btn")
          .addEventListener("click", window.FinexaModal.showNewLoanModal);
        if (document.getElementById("no-loans-apply-btn")) {
          document
            .getElementById("no-loans-apply-btn")
            .addEventListener("click", window.FinexaModal.showNewLoanModal);
        }
        document
          .getElementById("make-payment-btn")
          .addEventListener("click", () =>
            window.FinexaModal.showPaymentModal(null)
          );

        // Setup Logout Button
        document
          .getElementById("logout-btn")
          .addEventListener("click", async () => {
            await signOut();
            window.location.href = "auth.html";
          });
      }

      // --- MODAL CLOSING FUNCTIONS (Exposed to HTML via window.FinexaModal) ---

      // Define a global object to bridge functions to inline HTML handlers
      window.FinexaModal = {};

      window.FinexaModal.closeLoanDetailsModal = function () {
        document.getElementById("loan-details-modal").style.display = "none";
      };

      window.FinexaModal.closeNewLoanModal = function () {
        document.getElementById("new-loan-modal").style.display = "none";
        document.getElementById("new-loan-form").reset();
        document.getElementById("error-loanType").classList.add("hidden");
        document.getElementById("error-amount").classList.add("hidden");
        document.getElementById("error-durationMonths").classList.add("hidden");

        const submitButton = document.getElementById("new-loan-submit");
        submitButton.disabled = false;
        submitButton.textContent = "Submit Application";
      };

      window.FinexaModal.closePaymentModal = function () {
        document.getElementById("payment-modal").style.display = "none";
        document.getElementById("payment-form").reset();
        document.getElementById("error-payment").classList.add("hidden");
        document.getElementById("loan-details").classList.add("hidden");
        selectedLoanForPayment = null;
      };

      // FIX: Expose modal opening functions as well
      window.FinexaModal.showNewLoanModal = function () {
        document.getElementById("new-loan-modal").style.display = "flex";
      };

      // --- Payment Modal Details Update (NEW/REWRITTEN) ---
      function updateLoanDetails(loanId) {
        const detailsDiv = document.getElementById("loan-details");
        const balanceSpan = document.getElementById("loan-balance");
        const interestSpan = document.getElementById("loan-interest");

        if (!loanId) {
          detailsDiv.classList.add("hidden");
          return;
        }

        const loan = loans.find((l) => l.loan_id === loanId);
        if (loan) {
          // Display current outstanding balance
          balanceSpan.textContent = formatCurrency(loan.amount);
          interestSpan.textContent = `${loan.interest_rate}%`;
          detailsDiv.classList.remove("hidden");
        } else {
          detailsDiv.classList.add("hidden");
        }
      }

      window.FinexaModal.showPaymentModal = function (loanId = null) {
        const activeLoans = loans.filter((l) => l.status === "Active");
        const select = document.getElementById("payment-loan-select");
        const form = document.getElementById("payment-form");
        const noLoansMessage = document.getElementById("no-loans-message");

        // Clear previous options
        select.innerHTML = '<option value="">Choose a loan</option>';
        document.getElementById("error-payment").classList.add("hidden");
        document.getElementById("payment-amount").value = "";

        // Reset submit button text
        document.getElementById("pay-loan-submit").textContent =
          "Confirm Payment";

        if (activeLoans.length === 0) {
          form.classList.add("hidden");
          noLoansMessage.classList.remove("hidden");
          document.getElementById("payment-modal").style.display = "flex";
          return;
        }

        form.classList.remove("hidden");
        noLoansMessage.classList.add("hidden");

        activeLoans.forEach((loan) => {
          const option = document.createElement("option");
          option.value = loan.loan_id;
          option.textContent = `${loan.loan_type} - ${formatCurrency(
            loan.amount
          )} remaining`;
          select.appendChild(option);
        });

        if (loanId) {
          selectedLoanForPayment = loanId;
          select.value = loanId;
          updateLoanDetails(loanId);
        } else {
          // If no specific loan is pre-selected, clear details
          updateLoanDetails("");
        }

        // --- KEY CHANGE: Attach updateLoanDetails to select change ---
        select.onchange = (e) => {
          selectedLoanForPayment = e.target.value;
          updateLoanDetails(selectedLoanForPayment);
          document.getElementById("error-payment").classList.add("hidden");
        };

        document.getElementById("payment-amount").oninput = () => {
          document.getElementById("error-payment").classList.add("hidden");
        };

        document.getElementById("payment-modal").style.display = "flex";
      };

      // --- LOAN DETAILS MODAL CONTENT (FIXED) ---

      window.FinexaModal.showLoanDetails = function (loanId) {
        const loan = loans.find((l) => l.loan_id === loanId);
        if (!loan) {
          showToast("Loan details not found.", "error", "Data Error");
          return;
        }

        const display = getLoanDisplayStatus(loan);
        const isPastDue = display.status === "Past Due";
        const isPending = display.status === "Pending";
        const statusStyle = getStatusStyles(loan.status);
        const dueDate = calculateDueDate(loan.start_date, loan.duration_months);

        const destructiveClass = isPastDue ? "text-destructive" : "";

        document.getElementById(
          "modal-loan-type"
        ).textContent = `${loan.loan_type} Loan Details`;
        document.getElementById("modal-status").textContent = display.status;
        document.getElementById(
          "modal-status-card"
        ).className = `p-4 rounded-xl border ${statusStyle.replace(
          /text-.* /,
          "text-foreground"
        )} ${isPastDue ? "border-destructive/50" : "border-border"}`;
        document.getElementById(
          "modal-status"
        ).className = `font-semibold px-3 py-1 rounded-full text-xs ${display.style}`;

        const outstandingBalance = parseFloat(loan.amount);
        const totalPaid = loan.payments
          ? loan.payments.reduce((sum, p) => sum + parseFloat(p.amount_paid), 0)
          : 0;
        // Calculation: Remaining Balance + Total Paid = Original Principal
        const originalAmount = outstandingBalance + totalPaid;

        // 1. Current and Original Balance Display
        document.getElementById("modal-amount").textContent =
          formatCurrency(outstandingBalance);
        document.getElementById(
          "modal-amount"
        ).className = `font-bold text-lg ${destructiveClass}`;

        document.getElementById("modal-original-amount").textContent =
          formatCurrency(originalAmount);
        document.getElementById("modal-total-paid").textContent =
          formatCurrency(totalPaid);

        document.getElementById("modal-rate").textContent = `${parseFloat(
          loan.interest_rate
        )}%`;
        document.getElementById(
          "modal-duration"
        ).textContent = `${loan.duration_months} months`;
        document.getElementById("modal-collateral").textContent =
          loan.collateral || "N/A";

        document.getElementById("modal-created-at").textContent =
          loan.created_at ? loan.created_at.split("T")[0] : "N/A";
        document.getElementById("modal-approved-at").textContent =
          loan.start_date || "N/A";

        document.getElementById("modal-due-date").textContent = isPending
          ? "Pending Approval"
          : dueDate;
        document.getElementById("modal-due-date").className = `font-semibold ${
          isPastDue ? "text-destructive" : "text-foreground"
        }`;

        // 2. Payment History Listing
        const historyEl = document.getElementById("modal-payment-history");
        historyEl.innerHTML = "";

        if (loan.payments && loan.payments.length > 0) {
          loan.payments.sort(
            (a, b) => new Date(b.payment_date) - new Date(a.payment_date)
          );
          loan.payments.forEach((p) => {
            const item = document.createElement("div");
            item.className =
              "flex justify-between items-center py-1 border-b border-secondary/50 last:border-b-0";
            item.innerHTML = `
                    <span class="text-foreground font-medium">${formatCurrency(
                      p.amount_paid
                    )}</span>
                    <span class="text-muted-foreground text-xs">${new Date(
                      p.payment_date
                    ).toLocaleDateString()}</span>
                `;
            historyEl.appendChild(item);
          });
        } else {
          historyEl.innerHTML =
            '<div class="text-muted-foreground text-center py-2">No payments recorded yet.</div>';
        }

        const payButton = document.getElementById("modal-pay-button");
        if (loan.status === "Active" || isPastDue) {
          payButton.style.display = "block";
          payButton.textContent = isPastDue
            ? "Make Overdue Payment"
            : "Make Payment";
          payButton.onclick = (e) => {
            window.FinexaModal.closeLoanDetailsModal();
            window.FinexaModal.showPaymentModal(loan.loan_id);
          };
        } else {
          payButton.style.display = "none";
        }

        document.getElementById("loan-details-modal").style.display = "flex";
      };

      async function handleAddLoan(e) {
        e.preventDefault();
        const submitButton = document.getElementById("new-loan-submit");
        const originalText = "Submit Application";

        // 1. Get form data
        const form = {
          loanType: document.getElementById("loan-type").value,
          amount: document.getElementById("amount").value,
          durationMonths: document.getElementById("duration").value,
          collateral: document.getElementById("collateral").value,
        };

        // Clear previous errors
        document.getElementById("error-loanType").classList.add("hidden");
        document.getElementById("error-amount").classList.add("hidden");
        document.getElementById("error-durationMonths").classList.add("hidden");

        // Validation
        let hasErrors = false;
        if (!form.loanType) {
          document.getElementById("error-loanType").textContent =
            "Loan type is required";
          document.getElementById("error-loanType").classList.remove("hidden");
          hasErrors = true;
        }
        if (!form.amount || parseFloat(form.amount) <= 0) {
          document.getElementById("error-amount").textContent =
            "Valid amount is required";
          document.getElementById("error-amount").classList.remove("hidden");
          hasErrors = true;
        }
        if (!form.durationMonths || parseInt(form.durationMonths) <= 0) {
          document.getElementById("error-durationMonths").textContent =
            "Valid duration is required";
          document
            .getElementById("error-durationMonths")
            .classList.remove("hidden");
          hasErrors = true;
        }

        if (hasErrors) return;

        const newLoanData = {
          loanType: form.loanType,
          amount: parseFloat(form.amount),
          interestRate: INTEREST_RATES[form.loanType],
          durationMonths: parseInt(form.durationMonths),
          collateral: form.collateral || "None",
        };

        // 2. Insert via Supabase
        submitButton.disabled = true;
        submitButton.textContent = "Submitting...";

        try {
          const user = await getCurrentUser();
          if (!user || !user.id) {
            throw new Error("User session invalid. Please log in again.");
          }

          const { data, error } = await insertNewLoan(newLoanData, user.id);

          if (error) {
            showToast(`Submission failed: ${error.message}`, "error");
          } else {
            showToast(
              "Loan application submitted! Approval pending...",
              "warning"
            );
            window.FinexaModal.closeNewLoanModal();
            // Refetch to include the newly submitted loan in the local 'loans' array before scheduling
            await renderDashboard();
            // The renderDashboard call now handles scheduling approval for all pending loans
          }
        } catch (e) {
          showToast(`Error: ${e.message}`, "error");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }

      async function handlePayLoan(e) {
        e.preventDefault();

        const submitButton = document.getElementById("pay-loan-submit");
        const originalText = "Confirm Payment";

        const loanId = document.getElementById("payment-loan-select").value;
        const amountInput = document.getElementById("payment-amount");
        const paymentAmount = parseFloat(amountInput.value);
        const errorElement = document.getElementById("error-payment");

        // Find the loan object based on the current local state
        const loanToPay = loans.find((l) => l.loan_id === loanId);

        errorElement.classList.add("hidden");

        if (!loanToPay) {
          errorElement.textContent = "Please select a valid active loan.";
          errorElement.classList.remove("hidden");
          return;
        }

        // --- 1. Client-Side Validation: Check for payment constraints ---
        if (!paymentAmount || paymentAmount <= 0) {
          errorElement.textContent =
            "Please enter a valid amount greater than ₦0.";
          errorElement.classList.remove("hidden");
          return;
        }

        const outstandingBalance = parseFloat(loanToPay.amount);

        // Allow slight tolerance for floating point errors when paying off the last penny
        if (paymentAmount > outstandingBalance + 0.01) {
          errorElement.textContent = `Amount exceeds outstanding balance of ${formatCurrency(
            outstandingBalance
          )}.`;
          errorElement.classList.remove("hidden");
          return;
        }

        // --- 2. Call External Payment Function ---
        submitButton.disabled = true;
        submitButton.textContent = "Processing Payment...";

        try {
          const { success, message, newStatus } = await makePayment(
            loanId,
            paymentAmount
          );

          if (success) {
            if (newStatus === "Paid") {
              showToast("Loan fully paid off! 🎉", "success");
            } else {
              showToast(
                `Payment of ${formatCurrency(paymentAmount)} successful!`,
                "success"
              );
            }
            window.FinexaModal.closePaymentModal();
            await renderDashboard(); // Re-fetch and re-render to reflect the final database state
          } else {
            // Failure case from makePayment
            showToast(
              message || "Payment processing failed. Please try again.",
              "error"
            );
          }
        } catch (e) {
          showToast(`Error: ${e.message}`, "error");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }

      // --- INITIALIZATION ---
      document.addEventListener("DOMContentLoaded", async () => {
        const user = await getCurrentUser();

        if (!user) {
          window.location.href = "auth.html";
          return;
        }

        currentUserId = user.id;

        // Ensure the session storage is clear for a fresh start (optional for production)
        // sessionStorage.clear();

        await renderDashboard();

        document
          .getElementById("new-loan-form")
          .addEventListener("submit", handleAddLoan);
        document
          .getElementById("payment-form")
          .addEventListener("submit", handlePayLoan);
      });
    </script>
  </body>
</html>

